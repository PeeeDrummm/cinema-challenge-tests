name: CI/CD - Cinema Challenge Tests

on:
  push:
    branches:
      - develop

# Permiss√µes necess√°rias para que a Action possa criar um PR
permissions:
  contents: write
  pull-requests: write

jobs:
  run-tests:
    name: Run Robot Framework Tests
    runs-on: ubuntu-22.04

    # Bloco de vari√°veis de ambiente para o job de testes.
    # Elas s√£o lidas dos "Secrets" do seu reposit√≥rio.
    env:
      MONGO_URI: ${{ secrets.MONGO_URI }}
      # JWT_SECRET: ${{ secrets.JWT_SECRET }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        working-directory: ./cinema-automation
        run: pip install -r requirements.txt

      - name: Install Playwright system dependencies
        run: python -m playwright install-deps

      - name: Install Playwright browsers
        run: python -m playwright install

      - name: Run Robot Framework tests
        working-directory: ./cinema-automation
        run: robot --outputdir logs tests/

  create-pr:
    name: Create Pull Request to main
    # Garante que este job s√≥ rode se 'run-tests' for conclu√≠do com sucesso
    needs: run-tests
    runs-on: ubuntu-latest

    steps:
      # Este job tamb√©m precisa fazer o checkout para ter acesso ao reposit√≥rio
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Pull Request if one does not exist
        env:
          # Usamos o nosso Personal Access Token (PAT) para dar permiss√£o de cria√ß√£o de PR
          GITHUB_TOKEN: ${{ secrets.PAT }}
        run: |
          # Uma forma robusta de verificar se j√° existe um PR aberto
          EXISTING_PR=$(gh pr list --head develop --base main --state open --json number -q '.[0].number')
          
          if [ -z "$EXISTING_PR" ]; then
            echo "No open PR found from develop to main. Creating a new one."
            gh pr create \
              --base main \
              --head develop \
              --title "üîÅ [Automated] Merge develop into main after successful tests" \
              --body "‚úÖ Testes automatizados passaram com sucesso. PR gerado automaticamente."
          else
            echo "Pull Request #$EXISTING_PR from develop to main already exists. Nothing to do."
          fi
