name: CI/CD - Cinema Challenge Tests

on:
  push:
    branches:
      - develop

# Permiss√µes necess√°rias para que a Action possa criar um PR
permissions:
  contents: write
  pull-requests: write

jobs:
  run-tests:
    name: Run Robot Framework Tests
    runs-on: ubuntu-22.04

    env:
      MONGO_URI: ${{ secrets.MONGO_URI }}
      # JWT_SECRET: ${{ secrets.JWT_SECRET }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        working-directory: ./cinema-automation
        run: pip install -r requirements.txt

      - name: Install Playwright system dependencies
        run: python -m playwright install-deps

      - name: Install Playwright browsers
        run: python -m playwright install

      - name: Run Robot Framework tests
        working-directory: ./cinema-automation
        run: robot --outputdir logs tests/

  create-pr:
    name: Create Pull Request to main
    # Garante que este job s√≥ rode se 'run-tests' for conclu√≠do com sucesso
    needs: run-tests
    runs-on: ubuntu-latest

    steps:
      - name: Create Pull Request if one does not exist
        # Esta etapa usa a ferramenta oficial do GitHub (gh)
        env:
          # O GITHUB_TOKEN √© um segredo especial que o GitHub fornece automaticamente
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Verifica se j√° existe um PR aberto da 'develop' para a 'main'
          gh pr list --head develop --base main --state open --limit 1 | grep "No open pull requests found"
          
          # A linha acima falhar√° se um PR for encontrado. Se n√£o falhar (ou seja, se a mensagem "No open pull requests" for encontrada),
          # significa que podemos criar um novo PR. O '|| true' garante que o passo continue mesmo se o grep falhar.
          if [ $? -eq 0 ]; then
            echo "No open PR found from develop to main. Creating a new one."
            gh pr create \
              --base main \
              --head develop \
              --title "üîÅ [Automated] Merge develop into main after successful tests" \
              --body "‚úÖ Testes automatizados passaram com sucesso. PR gerado automaticamente."
          else
            echo "Pull Request from develop to main already exists. Nothing to do."
          fi
