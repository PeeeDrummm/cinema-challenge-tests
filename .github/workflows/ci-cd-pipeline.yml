# .github/workflows/ci-cd-pipeline.yml
name: CI/CD - Cinema Challenge Tests

on:
  push:
    branches:
      - develop

permissions:
  contents: write
  pull-requests: write

jobs:
  test-and-manage-pr:
    name: Test, Update README and Merge
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    runs-on: ubuntu-22.04

    env:
      MONGO_URI: ${{ secrets.MONGO_URI }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      GH_TOKEN: ${{ secrets.PAT }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: |
          pip install -r cinema-automation/requirements.txt
          pip install pytz

      - name: Install Playwright deps & browsers
        run: |
          python -m playwright install-deps
          python -m playwright install

      - name: Run Robot Framework tests
        working-directory: ./cinema-automation
        run: robot --outputdir logs tests/
        continue-on-error: true

      - name: Update README.md with test results
        run: python update_readme.py

      - name: Commit & Push README.md
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md
          if ! git diff --cached --quiet; then
            git commit -m "docs: ü§ñ Atualiza README e testes [skip ci]"
            git push origin develop
          fi

      - name: Upload Robot logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: robot-logs
          path: cinema-automation/logs/

      - name: Abort if tests failed
        run: |
          if grep -q 'status="FAIL"' cinema-automation/logs/output.xml; then
            echo "‚ùå Testes falharam. Encerrando."
            exit 1
          fi

      - name: Create & Merge PR via GH CLI
        shell: bash
        run: |
          # cria PR develop‚Üímain se n√£o existir
          if ! gh pr list --state open --base main --head develop | grep -q develop; then
            gh pr create \
              --title "Merge Autom√°tico: develop ‚û°Ô∏è main" \
              --body "‚úÖ Testes passaram e README atualizado." \
              --base main --head develop \
              --label automerge
          fi
          # captura o PR e faz squash + delete usando auto-merge
          PR_NUM=$(gh pr list --state open --base main --head develop --json number -q '.[0].number')
          gh pr merge "$PR_NUM" --squash --delete-branch --auto
